/**
 * Stamp was generated by <generateFileStamps.sh>
 * Last time was modified by <StampedFile.kt>
 *
 * Name: <AppEntry.kt>
 * Created: <02/07/2020, 11:27:00 PM>
 * Modified: <30/07/2020, 07:06:48 PM>
 * Version: <108>
 */

package worder

import javafx.stage.Stage
import tornadofx.App
import tornadofx.FX
import tornadofx.find
import worder.core.MainView
import worder.core.styles.WorderDefaultStyles
import worder.database.DatabaseController
import worder.insert.InsertController
import java.io.File
import java.nio.file.Path

class AppEntry : App(MainView::class, WorderDefaultStyles::class) {
    companion object {
        private val databaseController: DatabaseController = find()
        private val samplePath: Path = Path.of("stuff").resolve("sample")
        private val originalSampleDB: File = samplePath.resolve("sample-db.bck").toFile()
        private val devInsertFiles: List<File> = listOf(
                File("$samplePath/inserting/words0.txt"),
                File("$samplePath/inserting/words1.txt"),
                File("$samplePath/inserting/words2.txt"),
                File("$samplePath/inserting/words3.txt"),
                File("$samplePath/inserting/words4.txt"),
                File("$samplePath/inserting/words5.txt")
        )

        val mainView: MainView = find()
        val sampleDB: File = samplePath.resolve("sample-db_TMP.bck").toFile()
        val isConnectedToSample: Boolean
            get() = databaseController.db?.toString()?.substringAfterLast('/') == sampleDB.name
        var keepSample: Boolean = false


        private fun withSampleDB(block: (samplePath: Path) -> Unit) {
            if (!isConnectedToSample) {
                require(originalSampleDB.exists()) {
                    "There's no sample-db provided! Please check: $originalSampleDB"
                }

                originalSampleDB.copyTo(sampleDB, overwrite = true)
                databaseController.connectToSqlLiteFile(sampleDB)
            }

            block.invoke(samplePath)
        }


        fun runDevSample() = withSampleDB { }

        fun runDevInsert() = withSampleDB {
            mainView.switchToInsertTab()
            find<InsertController>().generateInsertBatch(devInsertFiles)
        }

        fun runDevInsertHard() = withSampleDB {
            val devInsertFilesMany = mutableListOf<File>().apply {
                repeat(10) {
                    addAll(devInsertFiles)
                }
            }

            mainView.switchToInsertTab()
            find<InsertController>().generateInsertBatch(devInsertFilesMany)
        }

        fun runDevUpdate() = withSampleDB {
            mainView.switchToUpdateTab()
        }
    }


    override fun start(stage: Stage) {
        stage.apply {
            icons += resources.image("/icons/worder-icon_512x512.png")
            isMaximized = true
        }

        super.start(stage)
        processArguments()
    }

    override fun stop() {
        databaseController.disconnect()

        if (isConnectedToSample && !keepSample)
            sampleDB.delete()

        super.stop()
    }


    private fun processArguments() {
        val mappedArgs = FX.application.parameters.raw
                .associateWith { WorderArgument.fromString(it) }

        require(mappedArgs.all { it.value != null }) {
            "Unexpected argument(s) has been passed! ${mappedArgs.filterValues { it == null }.keys}"
        }

        mappedArgs.apply {
            if (size > 0)
                mainView.title += " (${keys.joinToString(" ")})"
            forEach { it.value!!.action.invoke() }
        }
    }


    @Suppress("unused")
    enum class WorderArgument(val value: String, val description: String, val action: () -> Unit) {
        DEV_DATABASE("--dev-sample", "Automatically connects to the sampleDB.", AppEntry.Companion::runDevSample),
        DEV_INSERT("--dev-insert", "Development stage for the Insert Tab.", AppEntry.Companion::runDevInsert),
        DEV_INSERT_HARD("--dev-insert-hard", "Development stage for the Insert Tab with hard load.", AppEntry.Companion::runDevInsertHard),
        DEV_UPDATE("--dev-update", "Development stage for the Update Tab.", AppEntry.Companion::runDevUpdate),
        KEEP_SAMPLE_DB("--keep-sample-db", "Preserves sample-db-tmp file from removing at the end.", { withSampleDB { keepSample = true } });


        companion object {
            fun fromString(value: String): WorderArgument? {
                for (worderArgument in values())
                    if (worderArgument.value == value)
                        return worderArgument

                return null
            }
        }
    }
}
