/**
 * Stamp was generated by <generateFileStamps.sh>
 * Last time was modified by <StampedFile.kt>
 *
 * Name: <UpdateTabView.kt>
 * Created: <02/07/2020, 11:27:00 PM>
 * Modified: <17/11/2020, 11:19:15 AM>
 * Version: <15>
 */

package worder.gui.update

import javafx.scene.Parent
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch
import tornadofx.View
import tornadofx.stackpane
import worder.gui.database.DatabaseController
import worder.gui.database.DatabaseEventListener
import worder.gui.database.model.WorderDB
import worder.gui.database.model.WorderUpdateDB
import worder.gui.database.ui.NoConnectionFragment
import worder.gui.tornadofx.replaceChildren
import worder.gui.update.model.Requester
import worder.gui.update.model.WordBlock
import worder.gui.update.model.WordsPipeline
import worder.gui.update.model.impl.DefaultWordsPipeline
import worder.gui.update.model.impl.requesters.FakeRequester
import worder.gui.update.ui.WordsPipelineFragment

class UpdateTabView : View("Update"), DatabaseEventListener {
    private val notConnectedFragment = find<NoConnectionFragment>()
    private lateinit var wordsPipeline: WordsPipeline


    override val root: Parent = stackpane()


    init {
        find<DatabaseController>().subscribeAndRaise(this)
    }


    override fun onDatabaseConnection(db: WorderDB) {
        wordsPipeline = DefaultWordsPipeline.createInstance(
                database = db.updater,
                usedRequesters = Requester.defaultRequesters,
                selectOrder = WorderUpdateDB.SelectOrder.RANDOM
        )

        root.replaceChildren(find<WordsPipelineFragment>("wordsPipeline" to wordsPipeline))
    }

    override fun onDatabaseDisconnection() = root.replaceChildren(notConnectedFragment)

    fun commitLast() {
        CoroutineScope(Dispatchers.Default).launch {
            wordsPipeline.pipeline
                    .filter { it.status == WordBlock.WordBlockStatus.READY_TO_COMMIT }
                    .forEach { it.commit() }
        }
    }
}
